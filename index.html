<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Matriz de Cumplimiento CNBV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 text-gray-900">
  <header class="bg-blue-800 text-white py-6 text-center shadow">
    <h1 class="text-3xl font-bold">Evaluador de Cumplimiento Normativo Bancario</h1>
    <p class="text-sm">Basado en la Matriz CNBV (Circular Única de Bancos)</p>
  </header>

  <!-- ========== FORMULARIO ========== -->
  <section id="formulario" class="max-w-lg mx-auto my-8 p-8 bg-white rounded-xl shadow">
    <label class="block font-semibold mb-1">Nombre del Banco</label>
    <input id="nombreBanco" type="text" class="w-full mb-4 p-2 border rounded" placeholder="Ej. Banco Alfa" />

    <label class="block font-semibold mb-1">Tipo de banco</label>
    <select id="tipoBanco" class="w-full p-2 border rounded">
      <option value="universales">Universal</option>
      <option value="digitales">Digital</option>
      <option value="retail">Retail</option>
      <option value="patrimoniales">Patrimonial</option>
      <option value="nicho">De nicho</option>
      <option value="desarrollo">Desarrollo</option>
    </select>

    <button id="btnIniciar" class="mt-6 w-full bg-blue-700 text-white py-2 rounded hover:bg-blue-800">
      Iniciar evaluación
    </button>
  </section>

  <!-- ========== EVALUACIÓN ========== -->
  <section id="evaluacion" class="max-w-3xl mx-auto my-6 p-6 bg-white rounded-xl shadow hidden">
    <h2 id="tituloRiesgo" class="text-xl font-bold mb-4"></h2>
    <div id="listaReq" class="space-y-4"></div>
    <button id="btnSiguiente" class="mt-6 bg-green-700 text-white px-4 py-2 rounded hidden">
      Siguiente
    </button>
  </section>

  <!-- ========== RESULTADOS ========== -->
  <section id="resultado" class="max-w-4xl mx-auto my-10 p-6 bg-white rounded-xl shadow hidden">
    <h2 class="text-2xl font-bold text-center mb-6">Resultados de Cumplimiento</h2>
    <canvas id="graficoRiesgos" class="w-full h-64"></canvas>
    <div class="mt-8">
      <h3 class="text-lg font-bold mb-2">Resumen de Causales de Revocación</h3>
      <p id="resumenCausales"></p>
    </div>
  </section>

  <script>
    /* ---------------------- PONDERACIONES ---------------------- */
    const ponderaciones = {
      universales:   { riesgo_de_credito: 0.25, riesgo_de_mercado: 0.20, riesgo_operativo: 0.15, riesgo_legal: 0.05, riesgo_reputacional: 0.05, riesgo_tecnologico: 0.10, riesgo_liquidez: 0.20 },
      digitales:     { riesgo_de_credito: 0.20, riesgo_de_mercado: 0.05, riesgo_operativo: 0.15, riesgo_legal: 0.10, riesgo_reputacional: 0.15, riesgo_tecnologico: 0.20, riesgo_liquidez: 0.15 },
      retail:        { riesgo_de_credito: 0.40, riesgo_de_mercado: 0.05, riesgo_operativo: 0.15, riesgo_legal: 0.05, riesgo_reputacional: 0.10, riesgo_tecnologico: 0.10, riesgo_liquidez: 0.15 },
      patrimoniales: { riesgo_de_credito: 0.20, riesgo_de_mercado: 0.10, riesgo_operativo: 0.15, riesgo_legal: 0.15, riesgo_reputacional: 0.20, riesgo_tecnologico: 0.10, riesgo_liquidez: 0.10 },
      nicho:         { riesgo_de_credito: 0.35, riesgo_de_mercado: 0.05, riesgo_operativo: 0.10, riesgo_legal: 0.10, riesgo_reputacional: 0.10, riesgo_tecnologico: 0.10, riesgo_liquidez: 0.20 },
      desarrollo:    { riesgo_de_credito: 0.40, riesgo_de_mercado: 0.10, riesgo_operativo: 0.10, riesgo_legal: 0.05, riesgo_reputacional: 0.10, riesgo_tecnologico: 0.05, riesgo_liquidez: 0.20 }
    };

    /* ---------------------- ARCHIVOS ---------------------- */
    const riesgos = [
      "riesgo_de_credito",
      "riesgo_de_mercado",
      "riesgo_operativo",
      "riesgo_legal",
      "riesgo_reputacional",
      "riesgo_tecnologico",
      "riesgo_liquidez",
      "causal_de_revocacion"
    ];

    const rutaArchivo = r => `${r}.json`;

    /* ---------------------- ESTADO ---------------------- */
    let tipoBanco = "";
    let idxRiesgo = 0;
    const respuestas = {}; // {riesgo:[0|1]}
    let causalesCumple = 0, causalesTotal = 0;

    /* ---------------------- DOM ---------------------- */
    const $formulario = document.getElementById("formulario");
    const $evaluacion = document.getElementById("evaluacion");
    const $resultado  = document.getElementById("resultado");
    const $btnInit    = document.getElementById("btnIniciar");
    const $btnNext    = document.getElementById("btnSiguiente");
    const $titulo     = document.getElementById("tituloRiesgo");
    const $lista      = document.getElementById("listaReq");

    $btnInit.onclick = iniciar;
    $btnNext.onclick = avanzar;

    async function iniciar(){
      const nombre = document.getElementById("nombreBanco").value.trim();
      if(!nombre){ alert("Escribe el nombre del banco"); return; }
      tipoBanco = document.getElementById("tipoBanco").value;
      idxRiesgo = 0;
      await cargar();
      $formulario.classList.add("hidden");
      $evaluacion.classList.remove("hidden");
    }

    async function cargar(){
      const riesgo = riesgos[idxRiesgo];
      $titulo.textContent = formatea(riesgo);
      $lista.innerHTML = "Cargando…";
      $btnNext.classList.add("hidden");

      try{
        const datos = await fetch(rutaArchivo(riesgo)).then(r=>r.json());
        render(riesgo, datos);
      }catch(e){
        console.error(e);
        alert(`No se pudo cargar ${rutaArchivo(riesgo)}`);
      }
    }

    function render(riesgo, data){
      respuestas[riesgo] = new Array(data.length).fill(null);
      $lista.innerHTML = "";

      data.forEach((item,i)=>{
        const card = document.createElement("div");
        card.className="border p-4 rounded-lg bg-slate-50";

        const t = document.createElement("p");
        t.className="font-semibold";
        t.textContent = item["Requerimiento Normativo"] || `Req ${i+1}`;
        card.appendChild(t);

        const btnM = document.createElement("button");
        btnM.textContent = "Ver más info";
        btnM.className="text-blue-700 underline text-sm";
        const pre = document.createElement("pre");
        pre.className="hidden bg-slate-100 p-2 rounded text-xs overflow-auto mt-2";
        pre.textContent = JSON.stringify(item, null, 2);
        btnM.onclick = ()=>pre.classList.toggle("hidden");
        card.appendChild(btnM); card.appendChild(pre);

        const cont = document.createElement("div");
        cont.className="mt-3 flex gap-2";
        [
          {txt:"Cumple",val:1,cls:"bg-green-600"},
          {txt:"No cumple",val:0,cls:"bg-red-600"}
        ].forEach(cfg=>{
          const b=document.createElement("button");
          b.textContent=cfg.txt;
          b.className=`${cfg.cls} text-white px-3 py-1 rounded flex-1`;
          b.onclick=()=>{
            respuestas[riesgo][i]=cfg.val;
            cont.querySelectorAll("button").forEach(x=>x.classList.remove("opacity-40"));
            b.classList.add("opacity-40");
            if(!respuestas[riesgo].some(v=>v===null)) $btnNext.classList.remove("hidden");
          };
          cont.appendChild(b);
        });
        card.appendChild(cont);
        $lista.appendChild(card);
      });
    }

    async function avanzar(){
      const riesgo = riesgos[idxRiesgo];
      if(riesgo==="causal_de_revocacion"){
        respuestas[riesgo].forEach(v=>{ causalesTotal++; if(v===1) causalesCumple++; });
      }

      idxRiesgo++;
      if(idxRiesgo < riesgos.length){
        await cargar();
      }else{
        mostrar();
      }
    }

    function mostrar(){
      $evaluacion.classList.add("hidden");
      $resultado.classList.remove("hidden");

      const pesos = ponderaciones[tipoBanco];
      const labels=[], vals=[];
      riesgos.slice(0,7).forEach(r=>{
        const arr = respostas
