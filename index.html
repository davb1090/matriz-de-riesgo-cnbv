<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Matriz de Cumplimiento CNBV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 text-gray-900">
  <header class="bg-blue-800 text-white py-6 text-center shadow">
    <h1 class="text-3xl font-bold">Evaluador de Cumplimiento Normativo Bancario</h1>
    <p class="text-sm">Basado en la Matriz CNBV (Circular Única de Bancos)</p>
  </header>

  <section id="formulario" class="max-w-lg mx-auto my-8 p-8 bg-white rounded-xl shadow">
    <label class="block font-semibold mb-1">Nombre del Banco</label>
    <input id="nombreBanco" type="text" class="w-full mb-4 p-2 border rounded" placeholder="Ej. Banco Alfa" />

    <label class="block font-semibold mb-1">Tipo de banco</label>
    <select id="tipoBanco" class="w-full p-2 border rounded">
      <option value="universales">Universal</option>
      <option value="digitales">Digital</option>
      <option value="retail">Retail</option>
      <option value="patrimoniales">Patrimonial</option>
      <option value="nicho">De nicho</option>
      <option value="desarrollo">Desarrollo</option>
    </select>

    <button id="btnIniciar" class="mt-6 w-full bg-blue-700 text-white py-2 rounded hover:bg-blue-800">
      Iniciar evaluación
    </button>
  </section>

  <section id="evaluacion" class="max-w-3xl mx-auto my-6 p-6 bg-white rounded-xl shadow hidden">
    <h2 id="tituloRiesgo" class="text-xl font-bold mb-4"></h2>
    <div id="listaReq" class="space-y-4"></div>
    <button id="btnSiguiente" class="mt-6 bg-green-700 text-white px-4 py-2 rounded hidden">Siguiente</button>
  </section>

  <section id="resultado" class="max-w-4xl mx-auto my-10 p-6 bg-white rounded-xl shadow hidden">
    <h2 class="text-2xl font-bold text-center mb-6">Resultados de Cumplimiento</h2>
    <canvas id="graficoRiesgos" class="w-full h-64"></canvas>
    <div class="mt-8">
      <h3 class="text-lg font-bold mb-2">Causales de Revocación</h3>
      <p id="resumenCausales"></p>
    </div>
  </section>

<script>
// Configuración de ponderaciones y orden
const ponder = { /* ... */ };
const orden = ['riesgo_de_credito','riesgo_de_mercado','riesgo_operativo','riesgo_legal','riesgo_reputacional','riesgo_tecnologico','riesgo_liquidez','causal_de_revocacion'];
const fileOf = r=>`${r}.json`;

// Estado global
tipoBanco='';idx=0;respuestas={};causCumple=0;causTotal=0;

// DOM refs
const $form=document.getElementById('formulario'),$eval=document.getElementById('evaluacion'),$res=document.getElementById('resultado'),
      $btnInit=document.getElementById('btnIniciar'),$btnNext=document.getElementById('btnSiguiente'),
      $title=document.getElementById('tituloRiesgo'),$list=document.getElementById('listaReq');

$btnInit.onclick=iniciar; $btnNext.onclick=siguiente;

function iniciar(){
  const nom=document.getElementById('nombreBanco').value.trim();
  if(!nom){alert('Escribe el nombre del banco');return;}
  tipoBanco=document.getElementById('tipoBanco').value; idx=0; $form.classList.add('hidden'); $eval.classList.remove('hidden'); cargar();
}

async function cargar(){
  const r=orden[idx]; $title.textContent = format(r);
  $list.innerHTML='Cargando…'; $btnNext.classList.add('hidden');
  try{
    const txt=await fetch(fileOf(r)).then(r=>r.text());
    const data=JSON.parse(txt.replace(/NaN/g,'null'));
    render(r,data);
  }catch(e){alert(`No se pudo cargar ${fileOf(r)}`);}
}

function render(r,data){
  respuestas[r]=new Array(data.length).fill(null);
  $list.innerHTML='';
  data.forEach((item,i)=>{
    const card=document.createElement('div');card.className='border p-4 rounded-lg bg-slate-50';

    // Título
    const keyReq=Object.keys(item).find(k=>/requerimiento/i.test(k))||Object.keys(item)[0];
    const t=document.createElement('p');t.className='font-semibold';t.textContent=item[keyReq];card.appendChild(t);

    // Ver más
    const infoDiv=document.createElement('div');
    if(r==='causal_de_revocacion'){
      // tabla para causales
      const table=document.createElement('table');table.className='w-full table-auto text-sm border-collapse';
      const thead=document.createElement('thead');const trh=document.createElement('tr');
      Object.keys(item).forEach(h=>{const th=document.createElement('th');th.className='px-2 py-1 border bg-slate-100';th.textContent=h;trh.appendChild(th);});
      thead.appendChild(trh);table.appendChild(thead);
      const tbody=document.createElement('tbody');const trb=document.createElement('tr');
      Object.values(item).forEach(v=>{const td=document.createElement('td');td.className='px-2 py-1 border';td.textContent=v;trb.appendChild(td);});
      tbody.appendChild(trb);table.appendChild(tbody);
      infoDiv.appendChild(table);
    } else {
      const pre=document.createElement('pre');pre.className='hidden bg-slate-100 p-2 rounded text-xs overflow-auto mt-2';pre.textContent=JSON.stringify(item,null,2);
      infoDiv.appendChild(pre);
    }
    const btn=document.createElement('button');btn.textContent='Ver más info';btn.className='text-blue-700 underline text-sm';
    btn.onclick=()=>{const el=infoDiv.firstChild; el.classList.toggle('hidden');};
    card.appendChild(btn);card.appendChild(infoDiv);

    // Botones
    const wrap=document.createElement('div');wrap.className='mt-3 flex gap-2';
    [['Cumple',1,'bg-green-600'],['No cumple',0,'bg-red-600']].forEach(([txt,val,cls])=>{
      const b=document.createElement('button');b.textContent=txt; b.className=`${cls} text-white px-3 py-1 rounded flex-1`;
      b.onclick=()=>{respuestas[r][i]=val;wrap.querySelectorAll('button').forEach(x=>x.classList.remove('opacity-40'));b.classList.add('opacity-40'); if(!respuestas[r].includes(null))$btnNext.classList.remove('hidden');};
      wrap.appendChild(b);
    });
    card.appendChild(wrap);$list.appendChild(card);
  });
}

function siguiente(){
  const r=orden[idx]; if(r==='causal_de_revocacion'){respuestas[r].forEach(v=>{causTotal++; if(v===1)causCumple++;});}
  idx++; idx<orden.length?cargar():showRes();
}

function showRes(){
  $eval.classList.add('hidden');$res.classList.remove('hidden');
  const pesos=ponder[tipoBanco], labels=[],datos=[];
  orden.slice(0,7).forEach(r=>{const a=respuestas[r]; if(!a)return; const pct=a.reduce((s,v)=>s+v,0)/a.length; labels.push(format(r)); datos.push((pct*pesos[r]*100).toFixed(2));});
  new Chart(document.getElementById('graficoRiesgos').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'% Cumplimiento',data:datos}]},options:{scales:{y:{beginAtZero:true,max:100}}}});
  document.getElementById('resumenCausales').textContent=`Cumple ${causCumple} de ${causTotal} causales`;
}

function format(r){return r==='causal_de_revocacion'?'Causales de Revocación':r.replace(/_/g,' ').replace('riesgo ','').replace(/\w/g,c=>c.toUpperCase());}
</script>
</body>
</html>

