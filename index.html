<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Matriz de Cumplimiento CNBV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 text-gray-900">
  <header class="bg-blue-800 text-white py-6 text-center shadow">
    <h1 class="text-3xl font-bold">Evaluador de Cumplimiento Normativo Bancario</h1>
    <p class="text-sm">Basado en la Matriz CNBV (Circular Única de Bancos)</p>
  </header>

  <!-- ===== Formulario ===== -->
  <section id="formulario" class="max-w-lg mx-auto my-8 p-8 bg-white rounded-xl shadow">
    <label class="block font-semibold mb-1">Nombre del Banco</label>
    <input id="nombreBanco" class="w-full mb-4 p-2 border rounded" placeholder="Ej. Banco Alfa">

    <label class="block font-semibold mb-1">Tipo de banco</label>
    <select id="tipoBanco" class="w-full p-2 border rounded">
      <option value="universales">Universal</option>
      <option value="digitales">Digital</option>
      <option value="retail">Retail</option>
      <option value="patrimoniales">Patrimonial</option>
      <option value="nicho">De nicho</option>
      <option value="desarrollo">Desarrollo</option>
    </select>

    <button id="btnIniciar" class="mt-6 w-full bg-blue-700 text-white py-2 rounded hover:bg-blue-800">Iniciar evaluación</button>
  </section>

  <!-- ===== Evaluación ===== -->
  <section id="evaluacion" class="max-w-3xl mx-auto my-6 p-6 bg-white rounded-xl shadow hidden">
    <h2 id="tituloRiesgo" class="text-xl font-bold mb-4"></h2>
    <div id="listaReq" class="space-y-4"></div>
    <button id="btnSiguiente" class="mt-6 bg-green-700 text-white px-4 py-2 rounded hidden">Siguiente</button>
  </section>

  <!-- ===== Resultado ===== -->
  <section id="resultado" class="max-w-4xl mx-auto my-10 p-6 bg-white rounded-xl shadow hidden">
    <h2 class="text-2xl font-bold text-center mb-6">Resultados de Cumplimiento</h2>
    <canvas id="graficoRiesgos" class="w-full h-64"></canvas>
    <div class="mt-8">
      <h3 class="text-lg font-bold mb-2">Causales de Revocación</h3>
      <p id="resumenCausales"></p>
    </div>
  </section>

<script>
/**************** Configuración ****************/ 
// Ponderaciones (tabla convertida a proporciones 0‑1)
const ponder = {
  universales:   { riesgo_de_credito:0.25, riesgo_de_mercado:0.20, riesgo_operativo:0.15, riesgo_legal:0.05, riesgo_reputacional:0.05, riesgo_tecnologico:0.10, riesgo_liquidez:0.20 },
  digitales:     { riesgo_de_credito:0.20, riesgo_de_mercado:0.05, riesgo_operativo:0.15, riesgo_legal:0.10, riesgo_reputacional:0.15, riesgo_tecnologico:0.20, riesgo_liquidez:0.15 },
  retail:        { riesgo_de_credito:0.40, riesgo_de_mercado:0.05, riesgo_operativo:0.15, riesgo_legal:0.05, riesgo_reputacional:0.10, riesgo_tecnologico:0.10, riesgo_liquidez:0.15 },
  patrimoniales: { riesgo_de_credito:0.20, riesgo_de_mercado:0.10, riesgo_operativo:0.15, riesgo_legal:0.15, riesgo_reputacional:0.20, riesgo_tecnologico:0.10, riesgo_liquidez:0.10 },
  nicho:         { riesgo_de_credito:0.35, riesgo_de_mercado:0.05, riesgo_operativo:0.10, riesgo_legal:0.10, riesgo_reputacional:0.10, riesgo_tecnologico:0.10, riesgo_liquidez:0.20 },
  desarrollo:    { riesgo_de_credito:0.40, riesgo_de_mercado:0.10, riesgo_operativo:0.10, riesgo_legal:0.05, riesgo_reputacional:0.10, riesgo_tecnologico:0.05, riesgo_liquidez:0.20 }
};

// Orden de evaluación (nombres deben coincidir con archivos JSON sans acentos!)
const orden = [
  'riesgo_de_credito',
  'riesgo_de_mercado',
  'riesgo_operativo',
  'riesgo_legal',
  'riesgo_reputacional',
  'riesgo_tecnologico', // Asegúrate que tu archivo se llame riesgo_tecnologico.json SIN tilde
  'riesgo_liquidez',
  'causal_de_revocacion'
];

const fileOf = r => `${r}.json`;

/**************** Estado ****************/
let tipoBanco = '';
let idx = 0;
const respuestas = {}; // { riesgo: [0|1] }
let causalesCumple = 0, causalesTotal = 0;

/**************** DOM refs ****************/
const $form = document.getElementById('formulario');
const $eval = document.getElementById('evaluacion');
const $res  = document.getElementById('resultado');
const $btnInit = document.getElementById('btnIniciar');
const $btnNext = document.getElementById('btnSiguiente');
const $title   = document.getElementById('tituloRiesgo');
const $list    = document.getElementById('listaReq');

$btnInit.addEventListener('click', iniciar);
$btnNext.addEventListener('click', siguiente);

/**************** Funciones ****************/
function iniciar(){
  const nombre = document.getElementById('nombreBanco').value.trim();
  if(!nombre){ alert('Escribe el nombre del banco'); return; }
  tipoBanco = document.getElementById('tipoBanco').value;
  idx = 0;
  $form.classList.add('hidden');
  $eval.classList.remove('hidden');
  cargarRiesgo();
}

async function cargarRiesgo(){
  const riesgo = orden[idx];
  $title.textContent = format(riesgo);
  $list.innerHTML = 'Cargando…';
  $btnNext.classList.add('hidden');
  try{
    const data = await fetch(fileOf(riesgo)).then(r=>{if(!r.ok) throw new Error('404'); return r.json();});
    mostrarRequerimientos(riesgo, data);
  }catch(e){
    console.error(e);
    alert(`No se pudo cargar ${fileOf(riesgo)} - verifica nombre y ruta`);
  }
}

function mostrarRequerimientos(riesgo, data){
  respuestas[riesgo] = new Array(data.length).fill(null);
  $list.innerHTML = '';
  data.forEach((item,i)=>{
    const card = document.createElement('div');
    card.className = 'border p-4 rounded-lg bg-slate-50';

    const txt = document.createElement('p');
    txt.className = 'font-semibold';
    txt.textContent = item['Requerimiento Normativo'] || `Req ${i+1}`;
    card.appendChild(txt);

    const btnInfo = document.createElement('button');
    btnInfo.textContent = 'Ver más info';
    btnInfo.className = 'text-blue-700 underline text-sm';
    const pre = document.createElement('pre');
    pre.className = 'hidden bg-slate-100 p-2 rounded text-xs overflow-auto mt-2';
    pre.textContent = JSON.stringify(item, null, 2);
    btnInfo.onclick = ()=>pre.classList.toggle('hidden');
    card.appendChild(btnInfo);
    card.appendChild(pre);

    const wrap = document.createElement('div');
    wrap.className = 'mt-3 flex gap-2';
    [['Cumple',1,'bg-green-600'],['No cumple',0,'bg-red-600']].forEach(([t,val,cls])=>{
      const b=document.createElement('button');
      b.textContent=t; b.className=`${cls} text-white px-3 py-1 rounded flex-1`;
      b.onclick=()=>{
        respuestas[riesgo][i]=val;
        wrap.querySelectorAll('button').forEach(x=>x.classList.remove('opacity-40'));
        b.classList.add('opacity-40');
        if(!respuestas[riesgo].some(v=>v===null)) $btnNext.classList.remove('hidden');
      };
      wrap.appendChild(b);
    });
    card.appendChild(wrap);
    $list.appendChild(card);
  });
}

function siguiente(){
  const riesgoActual = orden[idx];
  if(riesgoActual==='causal_de_revocacion'){
    respuestas[riesgoActual].forEach(v=>{causalesTotal++; if(v===1) causalesCumple++;});
  }
  idx++;
  if(idx<orden.length){
    cargarRiesgo();
  }else{
    mostrarResultados();
  }
}

function mostrarResultados(){
  $eval.classList.add('hidden');
  $res.classList.remove('hidden');

  const pesos = ponder[tipoBanco];
  const labels=[], datos=[];
  orden.slice(0,7).forEach(r=>{
    const arr = respuestas[r]; if(!arr) return;
    const pct = arr.reduce((a,b)=>a+b,0)/arr.length; // 0-1
    labels.push(format(r));
    datos.push(Number((pct*pesos[r]*100).toFixed(2)));
  });

  new Chart(document.getElementById('graficoRiesgos').getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{label:'% Cumplimiento ponderado',data:datos}]},
    options:{scales:{y:{beginAtZero:true,max:100}}}
  });

  document.getElementById('resumenCausales').textContent = `Cumple ${causalesCumple} de ${causalesTotal} causales`;
}

function format(r){
  if(r==='causal_de_revocacion') return 'Causales de Revocación';
  return r.replace('riesgo_','').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
}
</script>
</body>
</html>

